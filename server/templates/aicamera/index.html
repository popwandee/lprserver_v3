{% extends "base.html" %}

{% block title %}AI Camera Manager - LPR Server v3{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-video text-primary"></i> AI Camera Manager
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> รีเฟรช
            </button>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <div class="h1 mb-0" id="totalCameras">0</div>
                <div class="h6 mb-0">กล้องทั้งหมด</div>
                <small class="text-white-50"><i class="fas fa-video"></i></small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <div class="h1 mb-0" id="onlineCameras">0</div>
                <div class="h6 mb-0">กล้องออนไลน์</div>
                <small class="text-white-50"><i class="fas fa-wifi"></i></small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <div class="h1 mb-0" id="offlineCameras">0</div>
                <div class="h6 mb-0">กล้องออฟไลน์</div>
                <small class="text-white-50"><i class="fas fa-exclamation-triangle"></i></small>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stat-card h-100">
            <div class="card-body text-center">
                <div class="h1 mb-0" id="totalDetections">0</div>
                <div class="h6 mb-0">การตรวจจับทั้งหมด</div>
                <small class="text-white-50"><i class="fas fa-car"></i></small>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle text-info"></i> เกี่ยวกับ AI Camera Manager
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    AI Camera Manager เป็นระบบจัดการกล้อง AI สำหรับการอ่านป้ายทะเบียนรถยนต์ 
                    ที่รองรับการเชื่อมต่อแบบ Real-time และการจัดการตั้งค่าต่างๆ
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>การลงทะเบียนกล้องอัตโนมัติ</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>การตรวจสอบสถานะ Real-time</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>การจัดการตั้งค่ากล้อง</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>การทดสอบการเชื่อมต่อ</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>สถิติการใช้งานกล้อง</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>การแจ้งเตือนเมื่อกล้องออฟไลน์</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs text-warning"></i> การใช้งาน
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <a href="{{ url_for('aicamera.cameras') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-video me-2"></i>จัดการกล้อง
                    </a>
                    <a href="{{ url_for('aicamera.camera_settings', camera_id='all') }}" class="btn btn-success btn-lg">
                        <i class="fas fa-cog me-2"></i>ตั้งค่า
                    </a>
                    <a href="{{ url_for('detection.records') }}" class="btn btn-info btn-lg">
                        <i class="fas fa-table me-2"></i>ดูข้อมูลการตรวจจับ
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Camera Status -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-video text-success"></i> สถานะกล้อง
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadCameraStatus()">
                    <i class="fas fa-sync-alt"></i> รีเฟรช
                </button>
            </div>
            <div class="card-body">
                <div id="cameraStatus">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> กำลังโหลดข้อมูล...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    loadCameraStatistics();
    loadCameraStatus();
    
    // Auto-refresh every 30 seconds
    setInterval(function() {
        loadCameraStatistics();
        loadCameraStatus();
    }, 30000);
});

function loadCameraStatistics() {
    fetch('/aicamera/api/cameras/statistics')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalCameras').textContent = data.statistics.total_cameras || 0;
                document.getElementById('onlineCameras').textContent = data.statistics.online_cameras || 0;
                document.getElementById('offlineCameras').textContent = data.statistics.offline_cameras || 0;
                document.getElementById('totalDetections').textContent = data.statistics.total_detections || 0;
            }
        })
        .catch(error => {
            console.error('Error loading camera statistics:', error);
        });
}

function loadCameraStatus() {
    fetch('/aicamera/api/cameras/status')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('cameraStatus');
            if (data.success && data.cameras && data.cameras.length > 0) {
                let html = '<div class="table-responsive"><table class="table table-striped">';
                html += '<thead><tr><th>กล้อง</th><th>สถานะ</th><th>IP Address</th><th>การตรวจจับล่าสุด</th><th>การดำเนินการ</th></tr></thead><tbody>';
                
                data.cameras.forEach(camera => {
                    const statusClass = camera.is_online ? 'text-success' : 'text-danger';
                    const statusIcon = camera.is_online ? 'fa-circle' : 'fa-circle';
                    const statusText = camera.is_online ? 'ออนไลน์' : 'ออฟไลน์';
                    
                    html += `<tr>
                        <td><strong>${camera.camera_id}</strong></td>
                        <td><i class="fas ${statusIcon} ${statusClass}"></i> ${statusText}</td>
                        <td>${camera.ip_address || 'N/A'}</td>
                        <td>${camera.last_detection || 'N/A'}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-info" onclick="viewCamera('${camera.camera_id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="testConnection('${camera.camera_id}')">
                                    <i class="fas fa-plug"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="text-center text-muted">ไม่มีข้อมูลกล้อง</div>';
            }
        })
        .catch(error => {
            console.error('Error loading camera status:', error);
            document.getElementById('cameraStatus').innerHTML = 
                '<div class="text-center text-danger">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>';
        });
}

function viewCamera(cameraId) {
    window.open(`/aicamera/cameras/${cameraId}`, '_blank');
}

function testConnection(cameraId) {
    showLoading();
    fetch(`/aicamera/api/cameras/${cameraId}/test-connection`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`การทดสอบการเชื่อมต่อ: ${data.result.status}`);
            } else {
                alert(`เกิดข้อผิดพลาด: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error testing connection:', error);
            alert('เกิดข้อผิดพลาดในการทดสอบการเชื่อมต่อ');
        })
        .finally(() => {
            hideLoading();
        });
}
</script>
{% endblock %}
